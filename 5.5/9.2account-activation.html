
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">

    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />

    <meta name="baidu-site-verification" content="MfC8ppEukL" />
    <!-- CSRF Token -->
    <meta name="csrf-token" content="hm5989AA5qOWRt4SjRmpClu004h3pj4sKMT34pNa">

    <title>账户激活 | 《Laravel 教程 - Web 开发实战入门 ( Laravel 5.5 )》 | Laravel 实战教程
    </title>

    <meta name="author" content="Summer" />
    <meta name="description" content="" />
    <meta name="keywords" content="" />

    <link rel="shortcut icon" href="../images/KDiyAbV0hj1ytHpRTOlVpucbLebonxeX.png"/>

    <!-- Styles -->
    <link href="../css/app.css" rel="stylesheet">
    <style>
        .ui.top.menu {border-top: 4px solid #f46660;}
    </style>
</head>
<body class=" books-articles-show-page">
<!--left-->
<div class="ui vertical  sidebar menu left" style="z-index: 99999">
    <div class="item">
        <b>Laravel 教程 - Web 开发实战入门 ( Laravel 5.5 )</b>
    </div>
    <div class="item">
        <div class="header">
            第一章. 基础信息
        </div>
        <div class="menu article">
            <a class="item" href="1.1about-the-book.html">1.1. 序言</a>
            <a class="item " href="1.2about-author.html">1.2. 关于作者</a>
            <a class="item " href="1.3laravel-and-php.html">1.3. Laravel 与 PHP</a>
            <a class="item " href="1.4reading-guide.html">1.4. 如何正确阅读本书？</a>
            <a class="item " href="1.5writing-convention.html">1.5. 写作约定</a>
            <a class="item " href="1.6release-notes.html">1.6. 发行说明</a>
            <a class="item " href="1.7the-book-source-code.html">1.7. 本书源码</a>
            <a class="item " href="1.8feedback-correction.html">1.8. 反馈纠错</a>
            <a class="item " href="1.9faq.html">1.9. 常见问题</a>
            <a class="item " href="1.10received-praise.html">1.10. 收到的赞誉</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第二章. 开发环境布置
        </div>

        <div class="menu article">
            <a class="item " href="2.1the-editor-to-choose.html">2.1. 编辑器选用</a>
            <a class="item " href="2.2command-line-tool.html">2.2. 命令行工具</a>
            <a class="item " href="2.3the-development-environment-to-build.html">2.3. 开发环境搭建</a>
            <a class="item " href="2.4development-environment-macos.html">2.4. 开发环境搭建 - MacOS</a>
            <a class="item " href="2.5development-environment-windows.html">2.5. 开发环境搭建 - Windows</a>
            <a class="item " href="2.6browser-selection.html">2.6. 浏览器选择</a>
            <a class="item " href="2.7the-first-application-hello-laravel.html">2.7. 第一个应用，Hello Laravel！</a>
            <a class="item " href="2.8git-and-making.html">2.8. Git 与 GitHub</a>
            <a class="item " href="2.9the-deployment-of.html">2.9. 部署上线</a>
            <a class="item " href="2.10summary.html">2.10. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第三章. 构建页面
        </div>
        <div class="menu article">
            <a class="item " href="3.1chapter.html">3.1. 章节说明</a>
            <a class="item " href="3.2create-an.html">3.2. 创建应用</a>
            <a class="item " href="3.3a-static-page.html">3.3. 静态页面</a>
            <a class="item " href="3.4artisan-command.html">3.4. Artisan 命令</a>
            <a class="item " href="3.5summary.html">3.5. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第四章. 优化页面
        </div>
        <div class="menu article">
            <a class="item " href="4.1chapter.html">4.1. 章节说明</a>
            <a class="item " href="4.2style-beautification.html">4.2. 样式美化</a>
            <a class="item " href="4.3laravel-front-end-workflow.html">4.3. Laravel 前端工作流</a>
            <a class="item " href="4.4local-view.html">4.4. 局部视图</a>
            <a class="item " href="4.5the-links-in-the-layout.html">4.5. 布局中的链接</a>
            <a class="item " href="4.6user-registration.html">4.6. 用户注册页面</a>
            <a class="item " href="4.7summary.html">4.7. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第五章. 用户模型
        </div>
        <div class="menu article">
            <a class="item " href="5.1chapter.html">5.1. 章节说明</a>
            <a class="item " href="5.2database-migration.html">5.2. 数据库迁移</a>
            <a class="item " href="5.3check-the-database-table.html">5.3. 查看数据库表</a>
            <a class="item " href="5.4model-file.html">5.4. 模型文件</a>
            <a class="item " href="5.5create-a-user-object.html">5.5. 创建用户对象</a>
            <a class="item " href="5.6to-find-the-user-object.html">5.6. 查找用户对象</a>
            <a class="item " href="5.7update-user-object.html">5.7. 更新用户对象</a>
            <a class="item " href="5.8summary.html">5.8. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第六章. 用户注册
        </div>
        <div class="menu article">
            <a class="item " href="6.1chapter.html">6.1. 章节说明</a>
            <a class="item " href="6.2according-to-the-users-information.html">6.2. 显示用户的信息</a>
            <a class="item " href="6.3registration-form.html">6.3. 注册表单</a>
            <a class="item " href="6.4the-user-data-validation.html">6.4. 用户数据验证</a>
            <a class="item " href="6.5registration-failed-error-message.html">6.5. 注册失败错误消息</a>
            <a class="item " href="6.6registered-successfully.html">6.6. 注册成功</a>
            <a class="item " href="6.7using-postgresql-on-heroku.html">6.7. 在 Heroku 上使用 PostgreSQL</a>
            <a class="item " href="6.8summary.html">6.8. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第七章. 会话管理
        </div>
        <div class="menu article">
            <a class="item " href="7.1chapter.html">7.1. 章节说明</a>
            <a class="item " href="7.2the-session.html">7.2. 会话</a>
            <a class="item " href="7.3the-user-login.html">7.3. 用户登录</a>
            <a class="item " href="7.4exit.html">7.4. 退出</a>
            <a class="item " href="7.5remember-that-i.html">7.5. 记住我</a>
            <a class="item " href="7.6summary.html">7.6. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第八章. 用户 CRUD
        </div>
        <div class="menu article">
            <a class="item " href="8.1chapter.html">8.1. 章节说明</a>
            <a class="item " href="8.2update-user.html">8.2. 更新用户</a>
            <a class="item " href="8.3permissions-system.html">8.3. 权限系统</a>
            <a class="item " href="8.4list-all-user.html">8.4. 列出所有用户</a>
            <a class="item " href="8.5delete-user.html">8.5. 删除用户</a>
            <a class="item " href="8.6summary.html">8.6. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第九章. 邮件发送
        </div>
        <div class="menu article">
            <a class="item " href="9.1chapter.html">9.1. 章节说明</a>
            <a class="item active" href="9.2account-activation.html">9.2. 账户激活</a>
            <a class="item " href="9.3password-reset.html">9.3. 密码重设</a>
            <a class="item " href="9.4in-a-production-environment-to-send-mail.html">9.4. 在生产环境中发送邮件</a>
            <a class="item " href="9.5summary.html">9.5. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第十章. 微博 CRUD
        </div>
        <div class="menu article">
            <a class="item " href="10.1chapter.html">10.1. 章节说明</a>
            <a class="item " href="10.2weibo-model.html">10.2. 微博模型</a>
            <a class="item " href="10.3according-to-weibo.html">10.3. 显示微博</a>
            <a class="item " href="10.4weibo-related-operations.html">10.4. 微博相关的操作</a>
            <a class="item " href="10.5summary.html">10.5. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第十一章. 粉丝关系
        </div>
        <div class="menu article">
            <a class="item " href="11.1chapter.html">11.1. 章节说明</a>
            <a class="item " href="11.2fan-data-table.html">11.2. 粉丝数据表</a>
            <a class="item " href="11.3focus-on-the-users-web-interface.html">11.3. 关注用户的网页界面</a>
            <a class="item " href="11.4dynamic-flow.html">11.4. 动态流</a>
            <a class="item " href="11.5summary.html">11.5. 小结</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第十二章. 附录
        </div>
        <div class="menu article">
            <a class="item " href="12.1proper-noun-index.html">12.1. 专有名词索引</a>
            <a class="item " href="12.2command-line-index.html">12.2. 命令行索引</a>
        </div>
    </div>

    <div class="item">
        <div class="header">
            第十三章. 附言
        </div>
        <div class="menu article">
            <a class="item " href="13.1the-next-step-study-suggest.html">13.1. 下一步的学习建议</a>
        </div>
    </div>
</div>
<!--left-->

<div class="ui basic teal  launch right attached fixed button">
    <i class="content icon"></i>
    <span class="text">Menu</span>
</div>

<div class="pusher">

    <div class="main container">

        <nav class="ui main borderless menu top stackable">
            <div class="ui container">
                <a href="../index.html" class="header item">
                    Laravel 实战教程 <div class="ui left pointing orange basic label" style="font-weight: normal;"> 全栈给我自由 </div>
                </a>


                <a href="https://laravel-china.org/topics" class="item no-pjax" >社区</a>
                <a href="https://laravel-china.org/categories/4" class="item">问答</a>

                <div class="ui fluid category search item">
                    <div class="ui icon input">
                        <input class="prompt" type="text" placeholder="">
                        <i class="search icon"></i>
                    </div>
                    <div class="results"></div>
                </div>


                <div class=" right menu stackable">
                    <div class="item">
                        <a class="ui basic green small button" href="https://laravel-china.org/auth/login"><i class="icon user "></i> 登录 </a>
                    </div>

                    <div class="item">
                        <a class="ui basic green small button" href="https://laravel-china.org/auth/register"><i class="icon signup "></i> 注册 </a>
                    </div>
                </div>

            </div>
        </nav>




        <div class="ui centered grid container stackable">

            <div class="twelve wide column">


                <div class="ui segment article-content">


                    <div class="extra-padding">

                        <h1>
                            <i class="grey file text outline icon"></i>
                            <span style="line-height: 34px;">9.2. 账户激活 </span>





                        </h1>

                        <p class="book-article-meta">

                            <a href="../index.html"><i class="icon book"></i> Laravel 教程 - Web 开发实战入门 ( Laravel 5.5 )</a>

                            <span class="divider">/</span>

                            <span class="relative clicked-hide-guide">
                <a class="chapter-title user-has-done-btn" data-act="chapter_sidebar_clicked" href="javascript:void(0);"><i class="icon map signs"></i> 第九章. 邮件发送</a>
    </span>

                        </p>



                        <div class="ui divider"></div>

                        <div class="ui readme markdown-body content-body">
                            <h2>账户激活</h2>
                            <p>现在的登录逻辑是，用户一旦注册成功即可进行登录，本节我们要加入账号激活功能，只有当用户成功激活自己的账号时才能在网站上进行登录。为此，我们将需要为用户表新增两个字段用于保存用户的激活令牌和激活状态。激活令牌用于验证用户身份，激活状态则用于判断用户是否已激活。</p>
                            <p>整个激活流程如下：</p>
                            <ol><li>用户注册成功后，自动生成激活令牌；</li>
                                <li>将激活令牌以链接的形式附带在注册邮件里面，并将邮件发送到用户的注册邮箱上；</li>
                                <li>用户点击注册链接跳到指定路由，路由收到激活令牌参数后映射给相关控制器动作处理；</li>
                                <li>控制器拿到激活令牌并进行验证，验证通过后对该用户进行激活，并将其激活状态设置为已激活；</li>
                                <li>用户激活成功，自动登录；</li>
                            </ol><p>接下来让我们跟之前一样，新建一个 Git 分支来开发新功能。</p>
                            <pre><code class="language-bash">$ git checkout master
$ git checkout -b account-activation-password-resets</code></pre>
                            <h2>资源</h2>
                            <h3>添加字段</h3>
                            <p>在用户的账号激活功能中，我们需要为激活令牌 (<code>activation_token</code>) 和激活状态 (<code>activated</code>) 字段新增一个迁移，来将这两个字段添加到用户表中。由于我们进行的是字段添加操作，因此在命名迁移文件时需要加上前缀，遵照如 <code>add_column_to_table</code> 这样的命名规范，并在生成迁移文件的命令中启用 <code>--table</code> 项目，用于指定对应的数据库表。最终的生成命令如下：</p>
                            <pre><code class="language-bash">$ php artisan make:migration add_activation_to_users_table --table=users</code></pre>
                            <p>我们将使用随机字符来生成用户的激活令牌，因此这里的激活令牌字段需要为 <code>string</code> 类型，在用户成功激活以后，我们还会对激活令牌进行清空，避免用户进行多次使用，因此我们还需要将字段设置为 <code>nullable</code>，代表该字段允许为空。而用户的激活状态只有已激活和未激活两种状态，默认为未激活的状态，因此我们可以将激活状态设置为 <code>boolean</code> 类型，当其值为真时，代表已激活，反之亦然。</p>
                            <p>现在让我们来为新增的迁移文件加上这两个字段。</p>
                            <p><em>database/migrations/[timestamp]_add_activation_to_users_table.php</em></p>
                            <pre><code class="language-php">&lt;?php

use Illuminate\Support\Facades\Schema;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Database\Migrations\Migration;

class AddActivationToUsersTable extends Migration
{
    /**
     * Run the migrations.
     *
     * @return void
     */
    public function up()
    {
        Schema::table('users', function (Blueprint $table) {
            $table-&gt;string('activation_token')-&gt;nullable();
            $table-&gt;boolean('activated')-&gt;default(false);
        });
    }

    /**
     * Reverse the migrations.
     *
     * @return void
     */
    public function down()
    {
        Schema::table('users', function (Blueprint $table) {
            $table-&gt;dropColumn('activation_token');
            $table-&gt;dropColumn('activated');
        });
    }
}</code></pre>
                            <p>接着我们还需要运行迁移，将字段加入到用户表中。</p>
                            <pre><code class="language-bash">$ php artisan migrate</code></pre>
                            <h2>生成令牌</h2>
                            <p>我们在前面说过，用户的激活令牌需要在用户创建（注册）之前就先生成好，这样当用户注册成功之后我们才可以将令牌附带到注册链接上，并通过邮件的形式发送给用户。</p>
                            <p>如果我们需要在模型被创建之前进行一些设置，则可以通过监听 <code>creating</code> 方法来做到。该方法是由 Eloquent 模型触发的一个<a href="http://d.laravel-china.org/docs/5.5/eloquent#events">事件</a>。事件是 Laravel 提供一种简单的监听器实现，我们可以对事件进行监听和订阅，从而在事件被触发时接收到响应并执行一些指定操作。Eloquent 模型默认提供了多个事件，我们可以通过其提供的事件来监听到模型的创建，更新，删除，保存等操作。<code>creating</code> 用于监听模型被创建之前的事件，<code>created</code> 用于监听模型被创建之后的事件。接下来我们要生成的用户激活令牌需要在用户模型创建之前生成，因此需要监听的是 <code>creating</code> 方法。</p>
                            <p>在用户模型中添加 <code>creating</code> 方法如下。</p>
                            <p><em>app/Models/User.php</em></p>
                            <pre><code class="language-php">&lt;?php

namespace App\Models;
.
.
.
class User extends Authenticatable
{
    .
    .
    .
    protected $hidden = ['password', 'remember_token'];

    public static function boot()
    {
        parent::boot();

        static::creating(function ($user) {
            $user-&gt;activation_token = str_random(30);
        });
    }
    .
    .
    .
}</code></pre>
                            <p><code>boot</code> 方法会在用户模型类完成初始化之后进行加载，因此我们对事件的监听需要放在该方法中。</p>
                            <p>现在，我们需要更新模型工厂，将生成的假用户和第一位用户都设为已激活状态。</p>
                            <p><em>database/factories/UserFactory.php</em></p>
                            <pre><code class="language-php">&lt;?php

use Faker\Generator as Faker;

/*
|--------------------------------------------------------------------------
| Model Factories
|--------------------------------------------------------------------------
|
| This directory should contain each of the model factory definitions for
| your application. Factories provide a convenient way to generate new
| model instances for testing / seeding your application's database.
|
*/

$factory-&gt;define(App\Models\User::class, function (Faker $faker) {
    $date_time = $faker-&gt;date . ' ' . $faker-&gt;time;
    static $password;

    return [
        'name' =&gt; $faker-&gt;name,
        'email' =&gt; $faker-&gt;safeEmail,
        'is_admin' =&gt; false,
        'activated' =&gt; true,
        'password' =&gt; $password ?: $password = bcrypt('secret'),
        'remember_token' =&gt; str_random(10),
        'created_at' =&gt; $date_time,
        'updated_at' =&gt; $date_time,
    ];
});</code></pre>
                            <p><em>database/seeds/UsersTableSeeder.php</em></p>
                            <pre><code class="language-php">&lt;?php

use Illuminate\Database\Seeder;
use App\Models\User;

class UsersTableSeeder extends Seeder
{
    /**
     * Run the database seeds.
     *
     * @return void
     */
    public function run()
    {
        $users = factory(User::class)-&gt;times(50)-&gt;make();
        User::insert($users-&gt;makeVisible(['password', 'remember_token'])-&gt;toArray());

        $user = User::find(1);
        $user-&gt;name = 'Aufree';
        $user-&gt;email = 'aufree@yousails.com';
        $user-&gt;password = bcrypt('password');
        $user-&gt;is_admin = true;
        $user-&gt;activated = true;
        $user-&gt;save();
    }
}</code></pre>
                            <p>完成之后，我们重置并填充数据库。</p>
                            <pre><code class="language-bash">$ php artisan migrate:refresh --seed</code></pre>
                            <h2>邮件程序</h2>
                            <p>在接下来的功能开发中，我们将使用 Laravel 来发送邮件，为了方便测试，我们需要对环境配置文件 <code>.env</code> 进行配置，使用 log 邮件驱动的方式来调试邮件发送功能，这么做的好处是邮件并不会真正被发送出去，而是会出现在 <code>storage/logs/laravel.log</code> 文件中，该文件记录着一切 Laravel 在运行时的日志信息，有助于我们在本地进行开发调试。</p>
                            <p><em>.env</em></p>
                            <pre><code class=" language-php">.
.
.
MAIL_DRIVER=log
.
.
.</code></pre>
                            <h2>激活账户</h2>
                            <h3>激活路由</h3>
                            <p>我们需要为用户的激活功能设定好路由，该路由将附带用户生成的激活令牌，在用户点击链接进行激活之后，我们需要将激活令牌通过路由参数传给控制器的指定动作，最终生成的激活链接例子如下：</p>
                            <pre><code class=" language-php">http://sample.app/signup/confirm/O1TTEr3faVq4fpzFXaOVQD4EAO9mQL</code></pre>
                            <p>由上面链接我们可以推导出路由的定义应该如下。</p>
                            <p><em>routes/web.php</em></p>
                            <pre><code class="language-php">&lt;?php

Route::get('/', 'StaticPagesController@home')-&gt;name('home');
Route::get('/help', 'StaticPagesController@help')-&gt;name('help');
Route::get('/about', 'StaticPagesController@about')-&gt;name('about');

Route::get('signup', 'UsersController@create')-&gt;name('signup');
Route::resource('users', 'UsersController');

Route::get('login', 'SessionsController@create')-&gt;name('login');
Route::post('login', 'SessionsController@store')-&gt;name('login');
Route::delete('logout', 'SessionsController@destroy')-&gt;name('logout');

Route::get('signup/confirm/{token}', 'UsersController@confirmEmail')-&gt;name('confirm_email');</code></pre>
                            <p>在 Laravel 中，我们使用视图来构建邮件模板，在用户查收邮件时，该模板将作为内容展示视图。接下来我们需要创建一个用于渲染注册邮件的 <code>confirm</code> 视图。</p>
                            <p><em>resources/views/emails/confirm.blade.php</em></p>
                            <pre><code class="language-html">&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;注册确认链接&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;感谢您在 Sample 网站进行注册！&lt;/h1&gt;

  &lt;p&gt;
    请点击下面的链接完成注册：
    &lt;a href="{{ route('confirm_email', $user-&gt;activation_token) }}"&gt;
      {{ route('confirm_email', $user-&gt;activation_token) }}
    &lt;/a&gt;
  &lt;/p&gt;

  &lt;p&gt;
    如果这不是您本人的操作，请忽略此邮件。
  &lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
                            <h3>登录时检查是否已激活</h3>
                            <p>在我们前面章节加入的登录操作中，用户即使没有激活也能够正常登录。接下来我们需要对之前的登录代码进行修改，当用户没有激活时，则视为认证失败，用户将会被重定向至首页，并显示消息提醒去引导用户查收邮件。</p>
                            <p><em>app/Http/Controllers/SessionsController.php</em></p>
                            <pre><code class="language-php">&lt;?php

namespace App\Http\Controllers;
.
.
.
class SessionsController extends Controller
{
    .
    .
    .
    public function store(Request $request)
    {
       $credentials = $this-&gt;validate($request, [
           'email' =&gt; 'required|email|max:255',
           'password' =&gt; 'required'
       ]);

       if (Auth::attempt($credentials, $request-&gt;has('remember'))) {
           if(Auth::user()-&gt;activated) {
               session()-&gt;flash('success', '欢迎回来！');
               return redirect()-&gt;intended(route('users.show', [Auth::user()]));
           } else {
               Auth::logout();
               session()-&gt;flash('warning', '你的账号未激活，请检查邮箱中的注册邮件进行激活。');
               return redirect('/');
           }
       } else {
           session()-&gt;flash('danger', '很抱歉，您的邮箱和密码不匹配');
           return redirect()-&gt;back();
       }
    }
    .
    .
    .
}</code></pre>
                            <h3>发送邮件</h3>
                            <p>接下来我们要开始使用邮箱发送功能，在 Laravel 中，可以通过 <code>Mail</code> 接口的 <code>send</code> 方法来进行邮件发送，示例如下：</p>
                            <pre><code class="language-php">$view = 'emails.confirm';
$data = compact('user');
$from = 'aufree@yousails.com';
$name = 'Aufree';
$to = $user-&gt;email;
$subject = "感谢注册 Sample 应用！请确认你的邮箱。";

Mail::send($view, $data, function ($message) use ($from, $name, $to, $subject) {
    $message-&gt;from($from, $name)-&gt;to($to)-&gt;subject($subject);
});</code></pre>
                            <p><code>Mail</code> 的 <code>send</code> 方法接收三个参数。</p>
                            <ul><li>第一个参数是包含邮件消息的视图名称。</li>
                                <li>第二个参数是要传递给该视图的数据数组。</li>
                                <li>最后是一个用来接收邮件消息实例的闭包回调，我们可以在该回调中自定义邮件消息的发送者、接收者、邮件主题等信息。</li>
                            </ul><p>接下来让我们为用户控制器定义一个 <code>sendEmailConfirmationTo</code> 方法，该方法将用于发送邮件给指定用户。我们会在用户注册成功之后调用该方法来发送激活邮件，具体代码实现如下。</p>
                            <p><em>app/Http/Controllers/UsersController.php</em></p>
                            <pre><code class="language-php">&lt;?php

namespace App\Http\Controllers;.
.
.
.
use Mail;

class UsersController extends Controller
{
    .
    .
    .
    public function store(Request $request)
    {
        $this-&gt;validate($request, [
            'name' =&gt; 'required|max:50',
            'email' =&gt; 'required|email|unique:users|max:255',
            'password' =&gt; 'required|confirmed|min:6'
        ]);

        $user = User::create([
            'name' =&gt; $request-&gt;name,
            'email' =&gt; $request-&gt;email,
            'password' =&gt; bcrypt($request-&gt;password),
        ]);

        $this-&gt;sendEmailConfirmationTo($user);
        session()-&gt;flash('success', '验证邮件已发送到你的注册邮箱上，请注意查收。');
        return redirect('/');
    }
    .
    .
    .
    protected function sendEmailConfirmationTo($user)
    {
        $view = 'emails.confirm';
        $data = compact('user');
        $from = 'aufree@yousails.com';
        $name = 'Aufree';
        $to = $user-&gt;email;
        $subject = "感谢注册 Sample 应用！请确认你的邮箱。";

        Mail::send($view, $data, function ($message) use ($from, $name, $to, $subject) {
            $message-&gt;from($from, $name)-&gt;to($to)-&gt;subject($subject);
        });
    }
}</code></pre>
                            <p>请注意我们需要调用 <code>use Mail</code> 来引入邮件相关的操作方法。通过上面代码可以看到，我们把之前用户注册成功之后进行的登录操作：</p>
                            <pre><code class="language-php">Auth::login($user);</code></pre>
                            <p>替换为了激活邮箱的发送操作：</p>
                            <pre><code class="language-php">$this-&gt;sendEmailConfirmationTo($user);</code></pre>
                            <p>注册成功提示语改为查看邮箱的提示语。在激活邮件发送成功之后，我们还会将用户重定向至首页，而并非之前的用户个人页。</p>
                            <h3>激活功能</h3>
                            <p>现在的邮箱发送功能已经能够正常使用，接下来让我们完成前面定义的 <code>confirm_email</code> 路由对应的控制器方法 <code>confirmEmail</code>，来完成用户的激活操作。并且在 <code>__construct</code> 方法里开启未登录用户访问权限。</p>
                            <p><em>app/Http/Controllers/UsersController.php</em></p>
                            <pre><code class="language-php">&lt;?php

namespace App\Http\Controllers;.
.
.
.
class UsersController extends Controller
{
    public function __construct()
    {

        $this-&gt;middleware('auth', [
            'except' =&gt; ['show', 'create', 'store', 'index', 'confirmEmail']
        ]);
        .
        .
        .

    }
    .
    .
    .
    public function confirmEmail($token)
    {
        $user = User::where('activation_token', $token)-&gt;firstOrFail();

        $user-&gt;activated = true;
        $user-&gt;activation_token = null;
        $user-&gt;save();

        Auth::login($user);
        session()-&gt;flash('success', '恭喜你，激活成功！');
        return redirect()-&gt;route('users.show', [$user]);
    }
}</code></pre>
                            <p>Auth 中间件黑名单中，我们增加了 <code>confirmEmail</code> 来开启未登录用户的访问。</p>
                            <p>在 <code>confirmEmail</code> 中，我们会先根据路由传送过来的 <code>activation_token</code> 参数从数据库中查找相对应的用户，Eloquent 的 <code>where</code> 方法接收两个参数，第一个参数为要进行查找的字段名称，第二个参数为对应的值，查询结果返回的是一个数组，因此我们需要使用 <code>firstOrFail</code> 方法来取出第一个用户，在查询不到指定用户时将返回一个 404 响应。在查询到用户信息后，我们会将该用户的激活状态改为 true，激活令牌设置为空。最后将激活成功的用户进行登录，并在页面上显示消息提示和重定向到个人页面。</p>
                            <p>如果我们尝试注册一个新用户：</p>
                            <p><img src="../images/JPN2AOmTwo.png" alt="file" /></p>
                            <p>便能够在 <code>laravel.log</code> 文件的最后面，看到有以下相关的内容输出。</p>
                            <p><em>storage/logs/laravel.log</em></p>
                            <pre><code class=" language-php">.
.
.
[2017-08-03 04:40:48] local.DEBUG: Message-ID: &lt;3e1472734effe20355c9cd888d2f47bd@sample.app&gt;
Date: Thu, 03 Aug 2017 04:40:47 +0000
Subject: =?utf-8?Q?=E6=84=9F=E8=B0=A2=E6=B3=A8=E5=86=8C?= Sample
 =?utf-8?Q?=E5=BA=94=E7=94=A8=EF=BC=81=E8=AF=B7?=
 =?utf-8?Q?=E7=A1=AE=E8=AE=A4=E4=BD=A0=E7=9A=84?=
 =?utf-8?Q?=E9=82=AE=E7=AE=B1=E3=80=82?=
From: Aufree &lt;aufree@yousails.com&gt;
To: summer2@yousails.com
MIME-Version: 1.0
Content-Type: text/html; charset=utf-8
Content-Transfer-Encoding: quoted-printable

&lt;!DOCTYPE html&gt;
&lt;html&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;title&gt;注册确认链接&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;h1&gt;感谢您在 Sample 网站进行注册！&lt;/h1&gt;

  &lt;p&gt;
    请点击下面的链接完成注册：
    &lt;a href="http://sample.app/signup/confirm/Du6ceeSFg0ok4ZPS4nE5lFwMPWAG2E"&gt;
      http://sample.app/signup/confirm/Du6ceeSFg0ok4ZPS4nE5lFwMPWAG2E
    &lt;/a&gt;
  &lt;/p&gt;

  &lt;p&gt;
    如果这不是您本人的操作，请忽略此邮件。
  &lt;/p&gt;
&lt;/body&gt;
&lt;/html&gt;  </code></pre>
                            <p>上面的邮件主题（Subject）由于 UTF-8 解码原因导致文字没有正常显示出来，不过没关系，通过 Log 我们已经可以判定邮件已经可以成功发送。在浏览器上尝试访问在 <code>laravel.log</code> 文件中输出的激活链接，则可以看到新注册用户被成功激活。</p>
                            <p><img src="../images/coAnOzwN6h.png" alt="file" /></p>
                            <p>现在我们已经完成用户激活功能的开发，可以先对代码进行提交：</p>
                            <pre><code class="language-bash">$ git add -A
$ git commit -m "Add account activations"</code></pre>
                        </div>

                    </div>


                </div>

                <div>
                    <a class="ui basic button small  pull-left popover " data-content="9.1. 章节说明" href="9.1chapter.html"><i class="icon arrow left"></i> 上一篇</a>
                    <a class="ui basic button small  pull-right popover " data-content="9.3. 密码重设 " href="9.3password-reset.html">下一篇 <i class="icon arrow right"></i></a>
                    <div class="clearfix"></div>
                </div>
            </div>
            <div class="four wide column">
                <div class="item header">

                    <div class="ui segment orange text-center" style="padding: 25px;">
                        刻意练习，每日精进。
                    </div>


                    <div class="ui segment">

                        <div class="ui three statistics">
                            <div class="ui huge statistic">
                                <div class="value">22</div>
                                <div class="label">点赞</div>
                            </div>
                            <div class="ui huge statistic">
                                <div class="value">9179</div>
                                <div class="label">浏览</div>
                            </div>
                            <div class="ui huge statistic">
                                <div class="value">1</div>
                                <div class="label">评论</div>
                            </div>
                        </div>

                        <br>

                    </div>
                </div>

                <div class="ui stackable cards">
                    <div class="ui  card column author-box grid" style="margin-top: 20px;">

                        <div class="ui fluid" style="margin-top: 20px;">
                            <div class="ui teal ribbon label"><i class="star icon"></i> 作者</div>
                        </div>

                        <a class="avatar-link">
                            <img class="ui centered circular tiny image "
                                 src="../images/1_1479342408.png">
                            </img>
                        </a>

                        <div class="extra content ui center aligned container">
                            <a class="header">Summer</a>
                            <div class="description"></div>
                        </div>
                    </div>
                </div>

                <div class="ui sticky" style="padding-top:20px">
                    <div class="ui  card column author-box grid " id="toc">
                    </div>
                </div>
            </div>

        </div>

    </div>

    <a class="circular ui icon button fixed feedback popover" data-content="建议与反馈 @Summer" data-position="left center">
        <i class="icon talk outline"></i>
    </a>

    <div class="ui inverted vertical footer segment">
        <div class="ui center aligned container">
            <div class="ui stackable inverted divided grid">
                <div class="four wide column">
                    <h4 class="ui inverted header">友站</h4>
                    <div class="ui inverted link list">
                        <a href="https://laravel-china.org/" class="item" target="_blank">Laravel China 社区</a>
                        <a href="https://easywechat.org/" class="item" target="_blank">EasyWechat</a>
                        <a href="https://yousails.com/" class="item" target="_blank">优帆远扬</a>
                    </div>
                </div>
                <div class="four wide column">
                    <h4 class="ui inverted header">资源推荐</h4>
                    <div class="ui inverted link list">
                        <a href="https://d.laravel-china.org/" class="item" target="_blank">Laravel 中文文档</a>
                        <a href="https://cs.laravel-china.org/" class="item" target="_blank">Laravel 速查表</a>
                    </div>
                </div>
                <div class="eight wide column">
                    <h4 class="ui inverted  header">Laravel 实战教程</h4>
                    <p>
                        编程是技能，不是知识，技能的唯一学习路径就是重复、实战性练习。
                    </p>

                    <p>
                        <a class="ui teal button" href="https://laravel-china.org/contact"><i class="icon idea "></i>
                            联系我
                        </a>
                    </p>
                </div>
            </div>

            <div class="ui inverted section divider"></div>
            <div>

                <p style="font-size:0.9em; margin-top:20px;margin-bottom: -8px;color: rgb(137, 137, 140);"
                   class="ui inverted ">
                    由 <a href="http://weibo.com/u/1837553744?is_hot=1" target="_blank"
                         style="color: inherit;">Summer</a> 设计和编码 <span style="color: #e27575;font-size: 14px;">❤</span>
                </p>
            </div>
        </div>
    </div>
</div>


<!-- Scripts -->
<script src="../js/app.js"></script>

</body>
</html>
